<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GreenHive - Gerenciador Financeiro</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        .content-fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
        .content-fade-out { animation: fadeOut 0.15s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(5px); } }
        body { background: linear-gradient(to bottom, white, #dcfce7); transition: background-color 0.3s ease; }
        .dark body { background: linear-gradient(to bottom, #111827, #043a25); }
        .dark .bg-white { background-color: #1f2937; }
        .dark .bg-gray-100 { background-color: #374151; }
        .dark .bg-gray-200 { background-color: #4b5563; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25); }
        .dark .text-gray-800 { color: #f9fafb; }
        .dark .text-gray-700 { color: #d1d5db; }
        .dark .text-gray-600, .dark .text-gray-500 { color: #9ca3af; }
        .dark .border-b, .dark .border { border-color: #4b5563; }
        .dark .divide-y > :not([hidden]) ~ :not([hidden]) { border-color: #4b5563; }
        .dark input, .dark select { background-color: #374151; color: #f9fafb; border-color: #4b5563;}
        .dark .filter-button-inactive { background-color: #4b5563; color: #d1d5db; }
        .dark .calendar-day:not(.bg-blue-500) { color: #d1d5db; }
        .dark .month-selector-text { color: #f9fafb !important; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="module">
        // Importando os pacotes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, updateDoc, arrayUnion, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAR3WgBFwC4mB0D1z2hNAbxjyENPzpWRks",
            authDomain: "tcc-etec-644.firebaseapp.com",
            projectId: "tcc-etec-644",
            storageBucket: "tcc-etec-644.firebasestorage.app",
            messagingSenderId: "182743524460",
            appId: "1:182743524460:web:355fab489855e13241e449",
            measurementId: "G-EXQ4K6B6ZK"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ESTADO GLOBAL DA APLICAÇÃO ---
        let state = {
            user: null,
            family: null,
            userFamilies: [],
            transactions: [],
            budgets: [],
            userCategories: { expense: [], income: [] },
            categoryColors: { 'Alimentação': '#F97316', 'Moradia': '#3B82F6', 'Transporte': '#EF4444', 'Lazer': '#8B5CF6', 'Saúde': '#14B8A6', 'Salário': '#10B981', 'Freelance': '#EAB308', 'Investimentos': '#06B6D4' },
            theme: localStorage.getItem('theme') || 'light',
            authView: 'login',
            currentView: 'auth',
            detailsFilterType: 'all',
            displayedMonth: new Date(),
            selectedDate: null,
            isModalOpen: false,
            editingTransactionId: null,
            editingBudgetItemId: null,
            modalView: '',
            modalTransactionType: 'expense',
            confirmingDelete: false,
        };

        const PALETTE_COLORS = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e', '#78716c', '#6b7280'];
        const CATEGORIES = { expense: ['Alimentação', 'Moradia', 'Transporte', 'Lazer', 'Saúde'], income: ['Salário', 'Freelance', 'Investimentos'] };

        const root = document.getElementById('root');
        let monthlyChartInstance, annualChartInstance, comparisonChartInstance, budgetChartInstance;
        Chart.register(ChartDataLabels);

        // --- LÓGICA / HANDLERS ---
        async function handleLogin(event) { event.preventDefault(); const email = event.target.email.value; const password = event.target.password.value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { alert("Falha no login: " + error.message); } }
        async function handleSignup(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; if (!name || !email || !password) { alert("Por favor, preencha todos os campos."); return; } try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(userCredential.user, { displayName: name }); } catch (error) { alert("Falha no cadastro: " + error.message); } }
        async function handleGoogleLogin() { const provider = new GoogleAuthProvider(); try { await signInWithPopup(auth, provider); } catch (error) { console.error("Erro no login com Google:", error); alert("Não foi possível fazer o login com o Google."); } }
        async function handleLogout() { await signOut(auth); }
        async function handleCreateFamily(event) { event.preventDefault(); const familyName = event.target.familyName.value; if (!familyName) return; const newFamily = { name: familyName, code: Math.random().toString(36).substring(2, 8).toUpperCase(), members: [state.user.uid], userCategories: { expense: [], income: [] }, categoryColors: state.categoryColors }; try { const docRef = await addDoc(collection(db, "familyGroups"), newFamily); await handleSelectFamily(docRef.id); } catch (e) { alert("Erro ao criar família."); console.error(e); } }
        async function handleJoinFamily(event) { event.preventDefault(); const code = event.target.inviteCode.value.toUpperCase(); if (!code) return; try { const q = query(collection(db, "familyGroups"), where("code", "==", code)); const querySnapshot = await getDocs(q); if (querySnapshot.empty) { alert("Código de família inválido!"); return; } const familyDoc = querySnapshot.docs[0]; const familyId = familyDoc.id; if (!familyDoc.data().members.includes(state.user.uid)) { await updateDoc(doc(db, "familyGroups", familyId), { members: arrayUnion(state.user.uid) }); } await handleSelectFamily(familyId); } catch (e) { alert("Erro ao entrar na família."); console.error(e); } }
        async function handleSelectFamily(familyId) { await loadFamilyData(familyId); if (state.family) { state.currentView = 'dashboard'; renderApp(); } }
        function handleLeaveFamily() { state.family = null; state.transactions = []; state.budgets = []; state.currentView = 'onboarding'; fetchUserFamilies().then(families => { state.userFamilies = families; renderApp(); }); }

        async function handleAddTransaction(event) {
            event.preventDefault();
            const formData = new FormData(event.target); const description = formData.get('description'); const amount = parseFloat(formData.get('amount')); const date = formData.get('date'); const category = formData.get('category'); const type = state.modalTransactionType;
            if (!description || !amount || !date || !category || category === '--create-new--') { alert('Por favor, preencha todos os campos e selecione uma categoria válida.'); return; }
            const newTransaction = { description, amount, date, category, type, userId: state.user.uid, userName: state.user.name, familyGroupId: state.family.id };
            try { const docRef = await addDoc(collection(db, "transactions"), newTransaction); state.transactions.push({ id: docRef.id, ...newTransaction }); state.transactions.sort((a, b) => new Date(b.date) - new Date(a.date)); state.isModalOpen = false; renderApp(); } catch (e) { alert("Erro ao adicionar transação."); console.error(e); }
        }
        async function handleUpdateTransaction(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const transactionId = state.editingTransactionId;
            const updatedData = { description: formData.get('description'), amount: parseFloat(formData.get('amount')), date: formData.get('date'), category: formData.get('category') };
            try { await updateDoc(doc(db, "transactions", transactionId), updatedData); const index = state.transactions.findIndex(t => t.id === transactionId); if (index !== -1) { state.transactions[index] = { ...state.transactions[index], ...updatedData }; } state.editingTransactionId = null; state.isModalOpen = false; renderApp(); } catch (e) { alert("Erro ao atualizar transação."); console.error(e); }
        }
        async function handleDeleteTransaction() {
            const transactionId = state.editingTransactionId;
            try { await deleteDoc(doc(db, "transactions", transactionId)); state.transactions = state.transactions.filter(t => t.id !== transactionId); state.editingTransactionId = null; state.isModalOpen = false; renderApp(); } catch (e) { alert("Erro ao excluir transação."); console.error(e); }
        }
        async function handleSaveBudget(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const id = state.editingBudgetItemId;
            const budgetData = {
                name: formData.get('budgetName'),
                type: formData.get('budgetType'),
                category: formData.get('budgetCategory'),
                value: parseFloat(formData.get('budgetValue')),
                appliesFrom: state.displayedMonth.toISOString().slice(0, 7) + '-01',
                recurring: formData.get('budgetRecurring') === 'on'
            };
            if (!budgetData.name || !budgetData.category || isNaN(budgetData.value)) { alert('Preencha todos os campos do orçamento com valores válidos.'); return; }
            try {
                const budgetCollectionRef = collection(db, "familyGroups", state.family.id, "budgets");
                if (id) {
                    await updateDoc(doc(budgetCollectionRef, id), budgetData);
                    const index = state.budgets.findIndex(b => b.id === id);
                    if (index !== -1) state.budgets[index] = { id, ...budgetData };
                } else {
                    const docRef = await addDoc(budgetCollectionRef, budgetData);
                    state.budgets.push({ id: docRef.id, ...budgetData });
                }
                state.editingBudgetItemId = null;
                state.isModalOpen = false;
                renderApp();
            } catch (e) { alert("Erro ao salvar orçamento."); console.error(e); }
        }
        async function handleDeleteBudget() {
            if (!state.editingBudgetItemId) return;
            const budgetId = state.editingBudgetItemId;
            const budgetToDelete = state.budgets.find(b => b.id === budgetId);
            const budgetDocRef = doc(db, "familyGroups", state.family.id, "budgets", budgetId);
            try {
                if (budgetToDelete && budgetToDelete.recurring) {
                    const lastMonth = new Date(state.displayedMonth);
                    lastMonth.setMonth(lastMonth.getMonth() - 1);
                    const appliesToDate = lastMonth.toISOString().slice(0, 7) + '-28';
                    await updateDoc(budgetDocRef, { appliesTo: appliesToDate });
                    budgetToDelete.appliesTo = appliesToDate;
                } else {
                    await deleteDoc(budgetDocRef);
                    state.budgets = state.budgets.filter(b => b.id !== budgetId);
                }
                state.editingBudgetItemId = null;
                state.isModalOpen = false;
                renderApp();
            } catch (e) { alert("Erro ao excluir orçamento."); console.error(e); }
        }
        async function handleSaveNewTag(event) {
            event.preventDefault();
            const form = event.target;
            const newTagName = form.newTagName.value;
            const newTagColor = form.newTagColor.value;
            if (!newTagName || !newTagColor) { alert('Por favor, preencha o nome e selecione uma cor.'); return; }
            const type = state.modalTransactionType;
            const allCategories = [...CATEGORIES[type], ...(state.userCategories[type] || [])];
            if (allCategories.includes(newTagName)) { alert('Essa categoria já existe.'); return; }
            try {
                const familyDocRef = doc(db, "familyGroups", state.family.id);
                await updateDoc(familyDocRef, {
                    [`userCategories.${type}`]: arrayUnion(newTagName),
                    [`categoryColors.${newTagName}`]: newTagColor
                });
                state.userCategories[type].push(newTagName);
                state.categoryColors[newTagName] = newTagColor;
                state.modalView = 'transaction';
                renderApp();
                setTimeout(() => { document.getElementById('category').value = newTagName; }, 0);
            } catch (e) { alert("Erro ao salvar nova categoria."); console.error(e); }
        }
        function handleChangeMonth(direction) {
            const viewContainer = document.getElementById('view-content') || document.getElementById('records-page-container');
            if (viewContainer) {
                viewContainer.classList.remove('content-fade-in');
                viewContainer.classList.add('content-fade-out');
                setTimeout(() => {
                    state.displayedMonth.setMonth(state.displayedMonth.getMonth() + direction);
                    state.selectedDate = null;
                    renderApp();
                }, 150);
            }
        }
        function handleToggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', state.theme);
            renderApp();
        }
        async function fetchUserFamilies() {
            if (!state.user?.uid) return [];
            try {
                const q = query(collection(db, "familyGroups"), where("members", "array-contains", state.user.uid));
                const querySnapshot = await getDocs(q);
                const families = [];
                querySnapshot.forEach(doc => { families.push({ id: doc.id, ...doc.data() }); });
                return families;
            } catch (error) { console.error("Erro ao buscar famílias:", error); return []; }
        }
        async function loadFamilyData(familyId) {
            try {
                const familyDocSnap = await getDoc(doc(db, "familyGroups", familyId));
                if (!familyDocSnap.exists()) throw new Error("Família não encontrada!");
                const familyData = familyDocSnap.data();
                state.family = { id: familyId, ...familyData };
                state.userCategories = familyData.userCategories || { expense: [], income: [] };
                state.categoryColors = familyData.categoryColors || state.categoryColors;

                const transactionsQuery = query(collection(db, "transactions"), where("familyGroupId", "==", familyId));
                const transactionsSnapshot = await getDocs(transactionsQuery);
                const loadedTransactions = [];
                transactionsSnapshot.forEach(doc => loadedTransactions.push({ id: doc.id, ...doc.data() }));
                state.transactions = loadedTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                const budgetsQuery = collection(db, "familyGroups", familyId, "budgets");
                const budgetsSnapshot = await getDocs(budgetsQuery);
                const loadedBudgets = [];
                budgetsSnapshot.forEach(doc => loadedBudgets.push({ id: doc.id, ...doc.data() }));
                state.budgets = loadedBudgets;
            } catch (e) {
                alert("Erro ao carregar dados da família.");
                console.error(e);
                handleLeaveFamily();
            }
        }
        
        // --- FUNÇÃO CENTRAL DE CONTROLE ---
        function renderApp() {
            document.documentElement.className = state.theme;
            let content = '';
            if (!state.user) {
                content = renderAuthPage();
            } else if (!state.family) {
                content = renderFamilyOnboardingPage();
            } else {
                content = renderMainContent();
            }
            root.innerHTML = renderHeader() + `<main>${content}</main>` + renderTransactionModal() + renderBudgetModal();
            attachEventListeners();
        }

        // --- ATTACH EVENT LISTENERS ---
        function attachEventListeners() {
            const loginForm = document.getElementById('login-form'); if (loginForm) loginForm.addEventListener('submit', handleLogin);
            const signupForm = document.getElementById('signup-form'); if (signupForm) signupForm.addEventListener('submit', handleSignup);
            const switchToSignup = document.getElementById('switch-to-signup'); if (switchToSignup) switchToSignup.addEventListener('click', () => { state.authView = 'signup'; renderApp(); });
            const switchToLogin = document.getElementById('switch-to-login'); if (switchToLogin) switchToLogin.addEventListener('click', () => { state.authView = 'login'; renderApp(); });
            const googleLoginButton = document.getElementById('google-login-button'); if (googleLoginButton) googleLoginButton.addEventListener('click', handleGoogleLogin);
            const createFamilyForm = document.getElementById('create-family-form'); if (createFamilyForm) createFamilyForm.addEventListener('submit', handleCreateFamily);
            const joinFamilyForm = document.getElementById('join-family-form'); if (joinFamilyForm) joinFamilyForm.addEventListener('submit', handleJoinFamily);
            document.querySelectorAll('.select-family-button').forEach(button => button.addEventListener('click', (e) => handleSelectFamily(e.currentTarget.dataset.familyId)));
            const userMenuButton = document.getElementById('user-menu-button'); if (userMenuButton) userMenuButton.addEventListener('click', () => document.getElementById('user-menu').classList.toggle('hidden'));
            const logoutButton = document.getElementById('logout-button'); if (logoutButton) logoutButton.addEventListener('click', handleLogout);
            const leaveFamilyButton = document.getElementById('leave-family-button'); if (leaveFamilyButton) leaveFamilyButton.addEventListener('click', handleLeaveFamily);
            document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', e => { const viewContainer = document.getElementById('view-content'); const newView = e.currentTarget.dataset.view; if (state.currentView !== newView && viewContainer) { viewContainer.classList.remove('content-fade-in'); viewContainer.classList.add('content-fade-out'); setTimeout(() => { state.currentView = newView; renderApp(); }, 150); } }));
            const themeToggleButton = document.getElementById('theme-toggle-button'); if (themeToggleButton) themeToggleButton.addEventListener('click', handleToggleTheme);
            const detailsButton = document.getElementById('details-button'); if (detailsButton) detailsButton.addEventListener('click', () => { state.currentView = 'records'; renderApp(); });
            const openModalButton = document.getElementById('open-modal-button'); if (openModalButton) openModalButton.addEventListener('click', () => { state.isModalOpen = true; state.modalView = 'transaction'; state.editingTransactionId = null; state.isCreatingTag = false; state.modalTransactionType = 'expense'; renderApp(); });
            const prevMonthChartButton = document.getElementById('prev-month-chart-button'); if (prevMonthChartButton) prevMonthChartButton.addEventListener('click', () => handleChangeMonth(-1));
            const nextMonthChartButton = document.getElementById('next-month-chart-button'); if (nextMonthChartButton) nextMonthChartButton.addEventListener('click', () => handleChangeMonth(1));
            const copyCodeButton = document.getElementById('copy-code-button'); if (copyCodeButton) copyCodeButton.addEventListener('click', () => navigator.clipboard.writeText(state.family.code).then(() => alert('Código copiado!')));
            const shareLinkButton = document.getElementById('share-link-button'); if (shareLinkButton) shareLinkButton.addEventListener('click', () => navigator.clipboard.writeText(`https://seusite.com/join?code=${state.family.code}`).then(() => alert('Link de convite copiado!')));
            const prevMonthButton = document.getElementById('prev-month-button'); if (prevMonthButton) prevMonthButton.addEventListener('click', () => handleChangeMonth(-1));
            const nextMonthButton = document.getElementById('next-month-button'); if (nextMonthButton) nextMonthButton.addEventListener('click', () => handleChangeMonth(1));
            document.querySelectorAll('.filter-button').forEach(button => button.addEventListener('click', (e) => { state.detailsFilterType = e.currentTarget.dataset.filter; state.selectedDate = null; renderApp(); }));
            document.querySelectorAll('.calendar-day').forEach(day => day.addEventListener('click', e => { const recordsList = document.getElementById('records-list-wrapper'); const dayNumber = parseInt(e.currentTarget.dataset.day); if (recordsList) { recordsList.classList.add('content-fade-out'); setTimeout(() => { state.selectedDate = dayNumber; renderApp(); }, 150); } }));
            document.querySelectorAll('.transaction-item').forEach(item => item.addEventListener('click', e => { const transactionId = e.currentTarget.dataset.transactionId; state.editingTransactionId = transactionId; state.isModalOpen = true; state.modalView = 'transaction'; renderApp(); }));
            const clearDateFilterButton = document.getElementById('clear-date-filter'); if (clearDateFilterButton) clearDateFilterButton.addEventListener('click', () => { state.selectedDate = null; renderApp(); });
            const addBudgetButton = document.getElementById('add-budget-button'); if (addBudgetButton) addBudgetButton.addEventListener('click', () => { state.isModalOpen = true; state.modalView = 'budget'; state.editingBudgetItemId = null; renderApp(); });
            document.querySelectorAll('.budget-item').forEach(item => item.addEventListener('click', e => { state.editingBudgetItemId = e.currentTarget.dataset.budgetId; state.isModalOpen = true; state.modalView = 'budget'; renderApp(); }));
            const closeModalButton = document.getElementById('close-modal-button'); if (closeModalButton) closeModalButton.addEventListener('click', () => { state.isModalOpen = false; state.editingTransactionId = null; state.editingBudgetItemId = null; renderApp(); });
            const confirmDeleteYes = document.getElementById('confirm-delete-yes'); if (confirmDeleteYes) confirmDeleteYes.addEventListener('click', state.editingTransactionId ? handleDeleteTransaction : handleDeleteBudget);
            const confirmDeleteNo = document.getElementById('confirm-delete-no'); if (confirmDeleteNo) confirmDeleteNo.addEventListener('click', () => { state.confirmingDelete = false; renderApp(); });
            const addTransactionForm = document.getElementById('add-transaction-form'); if (addTransactionForm) addTransactionForm.addEventListener('submit', handleAddTransaction);
            const editTransactionForm = document.getElementById('edit-transaction-form'); if (editTransactionForm) editTransactionForm.addEventListener('submit', handleUpdateTransaction);
            const deleteTransactionButton = document.getElementById('delete-transaction-button'); if (deleteTransactionButton) deleteTransactionButton.addEventListener('click', () => { state.confirmingDelete = true; renderApp(); });
            const budgetForm = document.getElementById('budget-form'); if (budgetForm) budgetForm.addEventListener('submit', handleSaveBudget);
            const deleteBudgetButton = document.getElementById('delete-budget-button'); if (deleteBudgetButton) deleteBudgetButton.addEventListener('click', () => { state.confirmingDelete = true; renderApp(); });
            const budgetTypeSelect = document.getElementById('budgetType'); if (budgetTypeSelect) budgetTypeSelect.addEventListener('change', () => { const form = budgetTypeSelect.closest('form'); const type = budgetTypeSelect.value; const allIncomeCategories = [...CATEGORIES.income, ...(state.userCategories.income || [])]; const allExpenseCategories = [...CATEGORIES.expense, ...(state.userCategories.expense || [])]; const options = (type === 'expense' ? allExpenseCategories : allIncomeCategories).map(c => `<option value="${c}">${c}</option>`).join(''); form.querySelector('#budgetCategory').innerHTML = options; });
            const categorySelect = document.getElementById('category'); if (categorySelect) categorySelect.addEventListener('change', (e) => { if (e.target.value === '--create-new--') { state.modalView = 'newTag'; renderApp(); } });
            const createTagForm = document.getElementById('create-tag-form'); if (createTagForm) createTagForm.addEventListener('submit', handleSaveNewTag);
            const cancelTagCreation = document.getElementById('cancel-tag-creation'); if (cancelTagCreation) cancelTagCreation.addEventListener('click', () => { state.modalView = 'transaction'; renderApp(); });
            const swipeTarget = document.getElementById('view-content'); if (swipeTarget && ['dashboard', 'records'].includes(state.currentView)) { let touchStartX = 0; let touchEndX = 0; swipeTarget.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true }); swipeTarget.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; if (touchEndX < touchStartX - 50) handleChangeMonth(1); if (touchEndX > touchStartX + 50) handleChangeMonth(-1); }); }
            if (state.currentView === 'dashboard') { renderMonthlyChart(); renderAnnualChart(); renderComparisonChart(); renderBudgetChart(); }
        }

        // --- PONTO DE PARTIDA E CONTROLE DE AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.user = { uid: user.uid, email: user.email, name: user.displayName || user.email.split('@')[0] };
                state.userFamilies = await fetchUserFamilies();
            } else {
                state.user = null; state.family = null; state.transactions = []; state.userFamilies = []; state.budgets = [];
                state.currentView = 'auth';
            }
            renderApp();
        });

        // --- DEFINIÇÃO DAS FUNÇÕES DE RENDERIZAÇÃO ---
        const iconHTML = `<img src="data:image/png;base64,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" alt="GreenHive Logo" width="32" height="32" />`;
        const themeIcon = () => state.theme === 'light' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
        function renderHeader() { if (!state.user) return ''; return `<header class="bg-white shadow-md w-full sticky top-0 z-10"><div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center"><div class="flex items-center gap-3">${iconHTML}<h1 class="text-xl font-bold text-gray-800">GreenHive</h1></div><div class="flex items-center gap-4"><button id="theme-toggle-button" class="p-2 rounded-full hover:bg-gray-100 transition">${themeIcon()}</button><div class="relative"><button id="user-menu-button" class="p-2 rounded-full hover:bg-gray-100 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></button><div id="user-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-2"><button id="logout-button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair da Conta</button></div></div></div></div></header>`; }
        function renderLoginFormHTML() { return `<h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">Acessar minha conta</h2><form id="login-form" novalidate><div class="space-y-6"><div><label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input id="email" name="email" type="email" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="voce@exemplo.com" /></div><div><div class="flex items-center justify-between"><label for="password" class="block text-sm font-medium text-gray-700">Senha</label><a href="#" class="text-sm font-medium text-green-600 hover:text-green-500 transition">Esqueceu a senha?</a></div><input id="password" name="password" type="password" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Sua senha" /></div><div><button type="submit" class="w-full flex justify-center py-3 px-4 border-transparent rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700">Entrar</button></div></div></form><p class="mt-8 text-center text-sm text-gray-600">Não tem uma conta?<button id="switch-to-signup" class="font-medium text-green-600 hover:text-green-500">Cadastre-se</button></p>`; }
        function renderSignupFormHTML() { return `<h2 class="text-2xl font-semibold text-center text-gray-700 mb-6">Criar nova conta</h2><form id="signup-form" novalidate><div class="space-y-6"><div><label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label><input id="name" name="name" type="text" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Seu nome" /></div><div><label for="email-signup" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input id="email-signup" name="email" type="email" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="voce@exemplo.com" /></div><div><label for="password-signup" class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input id="password-signup" name="password" type="password" required class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Crie uma senha forte" /></div><div><button type="submit" class="w-full flex justify-center py-3 px-4 border-transparent rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700">Criar Conta</button></div></div></form><p class="mt-8 text-center text-sm text-gray-600">Já tem uma conta?<button id="switch-to-login" class="font-medium text-green-600 hover:text-green-500">Faça login</button></p>`; }
        function renderAuthPage() { return `<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white p-8 rounded-2xl shadow-lg w-full animate-fade-in max-w-md mx-auto"><div class="text-center mb-8"><div class="flex justify-center items-center gap-3 mb-2">${iconHTML}<h1 class="text-3xl font-bold text-gray-800">GreenHive</h1></div><p class="text-gray-600">Sua colmeia financeira familiar.</p></div><div id="auth-form-container">${state.authView === 'login' ? renderLoginFormHTML() : renderSignupFormHTML()}</div></div></div>`; }
        function renderFamilyOnboardingPage() { let userFamiliesHTML = `<p class="text-center text-gray-500 p-4">Você ainda não faz parte de nenhuma família.</p>`; if (state.userFamilies.length > 0) { userFamiliesHTML = state.userFamilies.map(fam => `<div class="flex items-center justify-between p-4 border rounded-lg"><div><p class="font-semibold text-gray-800">${fam.name}</p></div><button data-family-id="${fam.id}" class="select-family-button px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg hover:bg-green-700">Acessar</button></div>`).join(''); } return `<div class="w-full max-w-4xl animate-fade-in p-4 mx-auto my-8"><h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">Bem-vindo(a), ${state.user.name}!</h1><div class="grid md:grid-cols-2 gap-8"><div class="bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-xl font-semibold text-gray-700 mb-4">Crie uma nova família</h2><form id="create-family-form"><label for="familyName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Família</label><input id="familyName" name="familyName" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ex: Família Silva" /><button type="submit" class="mt-4 w-full py-3 px-4 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700">Criar Família</button></form></div><div class="bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-xl font-semibold text-gray-700 mb-4">Ingresse em uma família</h2><form id="join-family-form"><label for="inviteCode" class="block text-sm font-medium text-gray-700 mb-1">Código de Convite</label><input id="inviteCode" name="inviteCode" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="INSIRA O CÓDIGO" /><button type="submit" class="mt-4 w-full py-3 px-4 rounded-lg font-medium text-white bg-gray-700 hover:bg-gray-800">Entrar com código</button></form></div></div><div class="mt-8 bg-white p-8 rounded-2xl shadow-lg"><h2 class="text-xl font-semibold text-gray-700 mb-4">Acesse uma de suas famílias</h2><div class="space-y-4">${userFamiliesHTML}</div></div></div>`; }
        function renderTransactionModal() { const isEditing = state.editingTransactionId !== null; if (!state.isModalOpen || (state.modalView !== 'transaction' && state.modalView !== 'newTag')) return ''; const transaction = isEditing ? state.transactions.find(t => t.id === state.editingTransactionId) : null; const type = isEditing ? transaction.type : state.modalTransactionType; const defaultCategories = (type === 'expense' ? CATEGORIES.expense : CATEGORIES.income); const customCategories = state.userCategories[type] || []; const allCategories = [...defaultCategories, ...customCategories]; let contentHTML = ''; if (state.modalView === 'newTag') { const colorSwatches = PALETTE_COLORS.map(color => `<label class="cursor-pointer"><input type="radio" name="newTagColor" value="${color}" class="sr-only peer"><div class="w-8 h-8 rounded-full peer-checked:ring-2 ring-offset-2 ring-blue-500" style="background-color: ${color};"></div></label>`).join(''); contentHTML = `<h3 class="text-lg font-semibold text-gray-700 mb-4">Criar Nova Categoria</h3><form id="create-tag-form"><div class="mb-4"><label for="newTagName" class="block text-sm font-medium text-gray-700 mb-1">Nome da Categoria</label><input id="newTagName" name="newTagName" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Ex: Combustível" required /></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Cor</label><div class="flex flex-wrap gap-3">${colorSwatches}</div></div><div class="mt-6 flex justify-end gap-2"><button type="button" id="cancel-tag-creation" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg">Cancelar</button><button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg">Salvar Categoria</button></div></form>`; } else { const categoryOptions = allCategories.map(cat => `<option value="${cat}" ${transaction?.category === cat ? 'selected' : ''}>${cat}</option>`).join('') + `<option value="--create-new--">Criar nova categoria...</option>`; const deleteButtonHTML = isEditing ? `<button type="button" id="delete-transaction-button" class="px-4 py-3 rounded-lg font-medium text-white bg-red-600 hover:bg-red-700">Excluir</button>` : ''; const confirmDeleteHTML = state.confirmingDelete ? `<div class="mt-4 p-4 bg-red-100 rounded-lg text-center"><p class="text-red-700 mb-2">Tem certeza?</p><button type="button" id="confirm-delete-yes" class="px-3 py-1 bg-red-600 text-white rounded-md mr-2">Sim</button><button type="button" id="confirm-delete-no" class="px-3 py-1 bg-gray-300 rounded-md">Não</button></div>` : ''; contentHTML = `<form id="${isEditing ? 'edit' : 'add'}-transaction-form"><div class="space-y-4"><div><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><input id="description" name="description" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" value="${transaction?.description || ''}" required /></div><div><label for="category" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label><select id="category" name="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">${categoryOptions}</select></div><div class="grid grid-cols-2 gap-4"><div><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label><input id="amount" name="amount" type="number" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg" value="${transaction?.amount || ''}" required /></div><div><label for="installments" class="block text-sm font-medium text-gray-700 mb-1">Parcelas</label><input id="installments" name="installments" type="number" min="1" value="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg disabled:bg-gray-100" ${isEditing || type === 'income' ? 'disabled' : ''} /></div></div><div><label for="date" class="block text-sm font-medium text-gray-700 mb-1">Data</label><input id="date" name="date" type="date" value="${transaction?.date || new Date().toISOString().slice(0, 10)}" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required /></div></div><div class="mt-8 flex gap-2">${deleteButtonHTML}<button type="submit" class="w-full py-3 px-4 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700">${isEditing ? 'Salvar Alterações' : 'Adicionar Transação'}</button></div>${confirmDeleteHTML}</form>`; } return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay p-4"><div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-8 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-700">${isEditing ? 'Editar Transação' : (state.modalView === 'newTag' ? 'Criar Categoria' : 'Nova Transação')}</h2><button id="close-modal-button" class="p-2 rounded-full hover:bg-gray-200 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>${contentHTML}</div></div>`; }
        function renderBudgetModal() { const isEditing = state.editingBudgetItemId !== null; if (!state.isModalOpen || state.modalView !== 'budget') return ''; const budget = isEditing ? state.budgets.find(b => b.id === state.editingBudgetItemId) : null; let type = budget?.type || 'expense'; const budgetTypeSelector = document.getElementById('budgetType'); if (budgetTypeSelector) { type = budgetTypeSelector.value; } const allIncomeCategories = [...CATEGORIES.income, ...(state.userCategories.income || [])]; const allExpenseCategories = [...CATEGORIES.expense, ...(state.userCategories.expense || [])]; const incomeOptions = allIncomeCategories.map(c => `<option value="${c}" ${budget?.category === c ? 'selected' : ''}>${c}</option>`).join(''); const expenseOptions = allExpenseCategories.map(c => `<option value="${c}" ${budget?.category === c ? 'selected' : ''}>${c}</option>`).join(''); const deleteButtonHTML = isEditing ? `<button type="button" id="delete-budget-button" class="px-4 py-3 rounded-lg font-medium text-white bg-red-600 hover:bg-red-700">Excluir</button>` : ''; const confirmDeleteHTML = state.confirmingDelete ? `<div class="mt-4 p-4 bg-red-100 rounded-lg text-center"><p class="text-red-700 mb-2">Tem certeza?</p><button type="button" id="confirm-delete-yes" class="px-3 py-1 bg-red-600 text-white rounded-md mr-2">Sim</button><button type="button" id="confirm-delete-no" class="px-3 py-1 bg-gray-300 rounded-md">Não</button></div>` : ''; return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay p-4"><div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-8 modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-700">${isEditing ? 'Editar' : 'Criar'} Orçamento</h2><button id="close-modal-button" class="p-2 rounded-full hover:bg-gray-200 transition"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><form id="budget-form"><div class="space-y-4"><div><label for="budgetName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Orçamento</label><input id="budgetName" name="budgetName" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" value="${budget?.name || ''}" placeholder="Ex: Teto com Comida" required /></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><select id="budgetType" name="budgetType" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white"><option value="expense" ${type === 'expense' ? 'selected' : ''}>Limite de Despesa</option><option value="income" ${type === 'income' ? 'selected' : ''}>Meta de Receita</option></select></div><div id="budget-category-wrapper"><label for="budgetCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label><select id="budgetCategory" name="budgetCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">${type === 'expense' ? expenseOptions : incomeOptions}</select></div><div><label for="budgetValue" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label><input id="budgetValue" name="budgetValue" type="number" step="0.01" class="w-full px-4 py-3 border border-gray-300 rounded-lg" value="${budget?.value || ''}" placeholder="0,00" required /></div><div class="flex items-center"><input id="budgetRecurring" name="budgetRecurring" type="checkbox" class="h-4 w-4 text-green-600 border-gray-300 rounded" ${budget?.recurring ?? true ? 'checked' : ''}><label for="budgetRecurring" class="ml-2 block text-sm text-gray-700">Repetir para os meses futuros</label></div></div><div class="mt-8 flex gap-2">${deleteButtonHTML}<button type="submit" class="w-full py-3 px-4 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700">${isEditing ? 'Salvar Alterações' : 'Criar Orçamento'}</button></div>${confirmDeleteHTML}</form></div></div>`; }
        function renderMainContent() { if (!state.family) return ''; const navTabs = `<div class="mb-8 border-b"><nav class="flex -mb-px space-x-8"><button data-view="dashboard" class="nav-tab ${state.currentView === 'dashboard' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Dashboard</button><button data-view="records" class="nav-tab ${state.currentView === 'records' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Registros</button><button data-view="budget" class="nav-tab ${state.currentView === 'budget' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Orçamento</button></nav></div>`; let viewContent = ''; if (state.currentView === 'dashboard') viewContent = renderFamilyDashboard(); else if (state.currentView === 'records') viewContent = renderRecordsPage(); else if (state.currentView === 'budget') viewContent = renderBudgetPage(); return `<div class="w-full max-w-6xl mx-auto px-4 py-8"><header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4"><div><h1 class="text-2xl font-bold text-gray-800">${state.family.name}</h1><p class="text-sm text-gray-500">Bem-vindo(a), ${state.user.name}!</p></div><button id="leave-family-button" class="mt-4 sm:mt-0 text-sm font-medium text-gray-600 hover:text-red-600 transition bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg">Sair da Família</button></header>${navTabs}<div id="view-content" class="content-fade-in">${viewContent}</div></div>`; }
        function renderFamilyDashboard() { const month = state.displayedMonth.getMonth(); const year = state.displayedMonth.getFullYear(); const monthName = state.displayedMonth.toLocaleString('pt-BR', { month: 'long' }); const monthlyTransactions = state.transactions.filter(t => new Date(t.date + 'T12:00:00').getMonth() === month && new Date(t.date + 'T12:00:00').getFullYear() === year); const summary = monthlyTransactions.reduce((acc, t) => { if (t.type === 'income') acc.income += t.amount; else acc.expenses += t.amount; return acc; }, { income: 0, expenses: 0 }); summary.balance = summary.income - summary.expenses; const incomeBudget = state.budgets.find(b => b.type === 'income' && new Date(b.appliesFrom) <= state.displayedMonth); const incomeGoal = incomeBudget ? incomeBudget.value : 0; const incomePercentage = incomeGoal > 0 ? (summary.income / incomeGoal) * 100 : 0; return `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-2xl shadow-lg"><p class="text-sm text-gray-500">Receita do Mês</p><p class="text-2xl font-bold text-gray-800 text-green-600">R$ ${summary.income.toFixed(2)}</p><p class="text-sm text-gray-500 mt-2">Meta: R$ ${incomeGoal.toFixed(2)}</p><div class="w-full bg-gray-200 rounded-full h-2 mt-1"><div class="bg-green-500 h-2 rounded-full" style="width: ${Math.min(incomePercentage, 100)}%"></div></div></div><div class="bg-white p-6 rounded-2xl shadow-lg"><p class="text-sm text-gray-500">Despesa do Mês</p><p class="text-2xl font-bold text-gray-800 text-red-600">R$ ${summary.expenses.toFixed(2)}</p></div><div class="bg-white p-6 rounded-2xl shadow-lg"><p class="text-sm text-gray-500">Saldo do Mês</p><p class="text-2xl font-bold text-gray-800 text-blue-600">R$ ${summary.balance.toFixed(2)}</p></div><div class="bg-white p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center text-center"><h3 class="font-semibold text-gray-700">Registro Geral</h3><p class="text-xs text-gray-500 mb-2">Veja todas as suas transações</p><button id="details-button" class="w-full mt-auto px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg">Ver mais</button></div></div><div class="bg-white p-6 rounded-2xl shadow-lg mb-6"><div class="flex justify-between items-center"><button id="prev-month-chart-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><h3 class="text-lg font-semibold capitalize month-selector-text">${monthName} de ${year}</h3><button id="next-month-chart-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Orçamento Mensal</h3><div class="h-80 relative"><canvas id="budget-overview-chart"></canvas><div id="budget-chart-text" class="absolute inset-0 flex flex-col items-center justify-center text-center pointer-events-none"></div></div></div><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Despesas do Mês por Categoria</h3><div class="h-80 relative"><canvas id="monthly-expenses-chart"></canvas></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8"><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Comparativo com Mês Anterior</h3><div class="h-80 relative"><canvas id="comparison-chart"></canvas></div></div><div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Balanço Anual (${new Date().getFullYear()})</h3><div class="h-80 relative"><canvas id="annual-balance-chart"></canvas></div></div></div><div class="mt-8 bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Código de Convite da Família</h3><div class="flex flex-col sm:flex-row items-center justify-between p-4 bg-gray-100 rounded-lg"><p class="text-2xl font-bold text-gray-800 tracking-widest mb-4 sm:mb-0">${state.family.code}</p><div class="flex gap-2"><button id="copy-code-button" class="px-4 py-2 text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 rounded-lg">Copiar Código</button><button id="share-link-button" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg">Compartilhar Link</button></div></div></div>${['dashboard', 'records'].includes(state.currentView) ? `<button id="open-modal-button" class="fixed bottom-8 right-8 bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>` : ''}`; }
        function renderRecordsPage() { const month = state.displayedMonth.getMonth(); const year = state.displayedMonth.getFullYear(); const monthName = state.displayedMonth.toLocaleString('pt-BR', { month: 'long' }); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); let calendarDaysHTML = Array(firstDay).fill(`<div class="text-center p-2"></div>`).join(''); for (let day = 1; day <= daysInMonth; day++) { const isSelected = state.selectedDate === day; calendarDaysHTML += `<div class="text-center p-1"><button data-day="${day}" class="calendar-day w-8 h-8 rounded-full ${isSelected ? 'bg-blue-500 text-white' : 'hover:bg-gray-200'}">${day}</button></div>`; } const calendarHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg mb-6"><div class="flex justify-between items-center mb-4"><button id="prev-month-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><h3 class="text-lg font-semibold capitalize month-selector-text">${monthName} de ${year}</h3><button id="next-month-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div><div class="grid grid-cols-7 gap-1 text-sm text-center text-gray-500 mb-2"><div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div></div><div class="grid grid-cols-7 gap-1">${calendarDaysHTML}</div>${state.selectedDate ? `<div class="text-center mt-4"><button id="clear-date-filter" class="text-sm text-blue-600 hover:underline">Limpar filtro do dia</button></div>` : ''}</div>`; const filtered = state.transactions.filter(t => { const transactionDate = new Date(t.date + 'T12:00:00'); const typeMatch = state.detailsFilterType === 'all' || t.type === state.detailsFilterType; const dateMatch = !state.selectedDate || transactionDate.getDate() === state.selectedDate; return typeMatch && dateMatch && transactionDate.getMonth() === month && transactionDate.getFullYear() === year; }); const groupedByDate = filtered.reduce((acc, t) => { const day = new Date(t.date + 'T12:00:00').getDate(); if (!acc[day]) acc[day] = []; acc[day].push(t); return acc; }, {}); const sortedDays = Object.keys(groupedByDate).sort((a,b) => b - a); let transactionsHTML = `<p class="text-center text-gray-500 py-8">Nenhuma transação encontrada para os filtros selecionados.</p>`; if (sortedDays.length > 0) { transactionsHTML = sortedDays.map(day => { const transactionsForDay = groupedByDate[day].map(t => `<li class="transaction-item flex justify-between items-center py-3 px-2 -mx-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 cursor-pointer" data-transaction-id="${t.id}"><div><p class="font-medium text-gray-800">${t.description}</p><div class="flex items-center mt-1"><p class="text-sm text-gray-500 mr-2">${t.userName || 'Autor desconhecido'}</p><span class="text-xs px-2 py-1 rounded-full text-white" style="background-color: ${state.categoryColors[t.category] || '#6B7280'}">${t.category}</span></div></div><p class="font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} R$ ${t.amount.toFixed(2)}</p></li>`).join(''); return `<div class="mb-4"><p class="font-bold text-gray-700 pb-2 border-b">${day} de ${monthName}</p><ul class="divide-y">${transactionsForDay}</ul></div>`; }).join(''); } return `<div id="records-page-container" class="content-fade-in"><div class="grid grid-cols-1 lg:grid-cols-5 gap-6"><div class="lg:col-span-2">${calendarHTML}</div><div class="lg:col-span-3"><div class="bg-white p-6 rounded-2xl shadow-lg mb-6"><div class="flex items-center justify-center gap-4"><button data-filter="all" class="filter-button px-4 py-2 rounded-lg ${state.detailsFilterType === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200 filter-button-inactive'}">Tudo</button><button data-filter="income" class="filter-button px-4 py-2 rounded-lg ${state.detailsFilterType === 'income' ? 'bg-green-500 text-white' : 'bg-gray-200 filter-button-inactive'}">Receitas</button><button data-filter="expense" class="filter-button px-4 py-2 rounded-lg ${state.detailsFilterType === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-200 filter-button-inactive'}">Despesas</button></div></div><div id="records-list-wrapper" class="bg-white rounded-2xl shadow-lg p-6">${transactionsHTML}</div></div></div> ${['dashboard', 'records'].includes(state.currentView) ? `<button id="open-modal-button" class="fixed bottom-8 right-8 bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>` : ''}</div>`; }
        function renderBudgetPage() { const month = state.displayedMonth.getMonth(); const year = state.displayedMonth.getFullYear(); const monthName = state.displayedMonth.toLocaleString('pt-BR', { month: 'long' }); const monthlyTransactions = state.transactions.filter(t => new Date(t.date + 'T12:00:00').getMonth() === month && new Date(t.date + 'T12:00:00').getFullYear() === year); const activeBudgets = state.budgets.filter(b => { const startDate = new Date(b.appliesFrom + 'T12:00:00'); const startYear = startDate.getUTCFullYear(); const startMonth = startDate.getUTCMonth(); const endDate = b.appliesTo ? new Date(b.appliesTo + 'T12:00:00') : null; const currentYear = state.displayedMonth.getFullYear(); const currentMonth = state.displayedMonth.getMonth(); const budgetStartsLater = startYear > currentYear || (startYear === currentYear && startMonth > currentMonth); if (budgetStartsLater) { return false; } if (b.recurring === false) { return startYear === currentYear && startMonth === currentMonth; } if (endDate) { const endYear = endDate.getUTCFullYear(); const endMonth = endDate.getUTCMonth(); const budgetEndsEarlier = endYear < currentYear || (endYear === currentYear && endMonth < currentMonth); if (budgetEndsEarlier) { return false; } } return true; }); const budgetItemsHTML = activeBudgets.map(budget => { let progressHTML = ''; if(budget.type === 'expense') { const spent = monthlyTransactions.filter(t => t.type === 'expense' && t.category === budget.category).reduce((sum, t) => sum + t.amount, 0); const limit = budget.value; const percentage = limit > 0 ? (spent / limit) * 100 : 0; const barColor = percentage > 100 ? 'bg-red-500' : (percentage > 80 ? 'bg-yellow-500' : 'bg-green-500'); progressHTML = `<div class="w-full bg-gray-200 rounded-full h-8 mt-2 relative overflow-hidden flex items-center"><div class="${barColor} h-8 rounded-full flex items-center justify-start pl-4" style="width: ${Math.min(percentage, 100)}%"></div><span class="absolute left-4 text-sm font-bold ${percentage > 50 ? 'text-white' : 'text-gray-800'}">${budget.name}</span></div><p class="text-xs text-right text-gray-500 mt-1">Gasto: R$ ${spent.toFixed(2)} de R$ ${limit.toFixed(2)}</p>`; } else { const earned = monthlyTransactions.filter(t => t.type === 'income' && t.category === budget.category).reduce((sum, t) => sum + t.amount, 0); const goal = budget.value; const percentage = goal > 0 ? (earned / goal) * 100 : 0; progressHTML = `<div class="w-full bg-gray-200 rounded-full h-8 mt-2 relative overflow-hidden flex items-center"><div class="bg-green-500 h-8 rounded-full flex items-center justify-start pl-4" style="width: ${Math.min(percentage, 100)}%"></div><span class="absolute left-4 text-sm font-bold ${percentage > 50 ? 'text-white' : 'text-gray-800'}">${budget.name}</span></div><p class="text-xs text-right text-gray-500 mt-1">Alcançado: R$ ${earned.toFixed(2)} de R$ ${goal.toFixed(2)}</p>`; } return `<div class="budget-item p-4 border rounded-lg cursor-pointer hover:bg-gray-100" data-budget-id="${budget.id}">${progressHTML}</div>`; }).join(''); return `<main class="content-fade-in"><div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg"> <h3 class="text-lg font-semibold text-gray-700 mb-4">Mês do Orçamento</h3><div class="flex items-center justify-between"><button id="prev-month-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button><span class="font-semibold capitalize month-selector-text">${monthName} de ${year}</span><button id="next-month-button" class="p-2 rounded-md hover:bg-gray-200 month-selector-text"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button></div></div><div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-lg font-semibold text-gray-700 mb-4">Orçamentos para ${monthName}</h3><div class="space-y-4">${budgetItemsHTML}<button id="add-budget-button" class="w-full p-4 border-2 border-dashed rounded-lg text-gray-500 hover:bg-gray-100 hover:border-green-500">+ Adicionar Novo Orçamento</button></div></div></div></main>`; }
        function renderMonthlyChart() { const chartCanvas = document.getElementById('monthly-expenses-chart'); if (chartCanvas) { if (monthlyChartInstance) monthlyChartInstance.destroy(); const month = state.displayedMonth.getMonth(); const year = state.displayedMonth.getFullYear(); const monthlyTransactions = state.transactions.filter(t => new Date(t.date + 'T12:00:00').getMonth() === month && new Date(t.date + 'T12:00:00').getFullYear() === year && t.type === 'expense'); const expenseData = monthlyTransactions.reduce((acc, t) => { const category = t.category || 'Outros'; acc[category] = (acc[category] || 0) + t.amount; return acc; }, {}); const labels = Object.keys(expenseData); const data = Object.values(expenseData); const colors = labels.map(label => state.categoryColors[label] || '#6B7280'); const textColor = state.theme === 'dark' ? '#d1d5db' : '#374151'; monthlyChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: state.theme === 'dark' ? '#1f2937' : '#f9fafb', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } }, datalabels: { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = total > 0 ? (value / total * 100).toFixed(0) + '%' : '0%'; return percentage; }, color: '#fff', font: { weight: 'bold' } } } } }); } }
        function renderAnnualChart() { const chartCanvas = document.getElementById('annual-balance-chart'); if (chartCanvas) { if (annualChartInstance) annualChartInstance.destroy(); const currentYear = new Date().getFullYear(); const annualData = { income: Array(12).fill(0), expense: Array(12).fill(0) }; state.transactions.forEach(t => { const transactionDate = new Date(t.date + 'T12:00:00'); if (transactionDate.getFullYear() === currentYear) { const month = transactionDate.getMonth(); if (t.type === 'income') annualData.income[month] += t.amount; else annualData.expense[month] += t.amount; } }); const textColor = state.theme === 'dark' ? '#d1d5db' : '#374151'; annualChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'bar', data: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], datasets: [ { label: 'Receitas', data: annualData.income, backgroundColor: 'rgba(16, 185, 129, 0.6)' }, { label: 'Despesas', data: annualData.expense, backgroundColor: 'rgba(239, 68, 68, 0.6)' } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } }, datalabels: { display: false } }, scales: { x: { stacked: false, ticks: { color: textColor } }, y: { stacked: false, ticks: { color: textColor } } } } }); } }
        function renderComparisonChart() { const chartCanvas = document.getElementById('comparison-chart'); if (chartCanvas) { if (comparisonChartInstance) comparisonChartInstance.destroy(); const currentMonthDate = state.displayedMonth; const prevMonthDate = new Date(currentMonthDate); prevMonthDate.setMonth(prevMonthDate.getMonth() - 1); const getExpensesForMonth = (date) => state.transactions.filter(t => { const tDate = new Date(t.date + 'T12:00:00'); return t.type === 'expense' && tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear(); }).reduce((sum, t) => sum + t.amount, 0); const currentMonthExpenses = getExpensesForMonth(currentMonthDate); const prevMonthExpenses = getExpensesForMonth(prevMonthDate); const textColor = state.theme === 'dark' ? '#d1d5db' : '#374151'; comparisonChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'bar', data: { labels: [prevMonthDate.toLocaleString('pt-BR', {month: 'long'}), currentMonthDate.toLocaleString('pt-BR', {month: 'long'})], datasets: [{ label: 'Total de Despesas', data: [prevMonthExpenses, currentMonthExpenses], backgroundColor: ['rgba(107, 114, 128, 0.6)', 'rgba(239, 68, 68, 0.6)'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (value) => `R$ ${value.toFixed(2)}`, color: textColor, font: { weight: 'bold' } } }, scales: { x: { ticks: { color: textColor } }, y: { ticks: { color: textColor } } } } }); } }
        function renderBudgetChart() { const chartCanvas = document.getElementById('budget-overview-chart'); if (chartCanvas) { if (budgetChartInstance) budgetChartInstance.destroy(); const month = state.displayedMonth.getMonth(); const year = state.displayedMonth.getFullYear(); const monthlyTransactions = state.transactions.filter(t => new Date(t.date + 'T12:00:00').getMonth() === month && new Date(t.date + 'T12:00:00').getFullYear() === year); const totalExpenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0); const activeExpenseBudgets = state.budgets.filter(b => b.type === 'expense' && new Date(b.appliesFrom) <= state.displayedMonth && (!b.appliesTo || new Date(b.appliesTo) >= state.displayedMonth)); const totalBudget = activeExpenseBudgets.reduce((sum, b) => sum + b.value, 0); const remaining = totalBudget - totalExpenses; const textColor = state.theme === 'dark' ? '#d1d5db' : '#374151'; budgetChartInstance = new Chart(chartCanvas.getContext('2d'), { type: 'doughnut', data: { labels: ['Gasto', 'Restante'], datasets: [{ data: [totalExpenses, remaining > 0 ? remaining : 0], backgroundColor: ['#EF4444', '#10B981'], borderColor: state.theme === 'dark' ? '#1f2937' : '#f9fafb', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } }, datalabels: {formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return total > 0 ? (value / total * 100).toFixed(0) + '%' : '0%'; }, color: '#fff'} }, cutout: '70%' } }); const budgetText = document.getElementById('budget-chart-text'); if (budgetText) { const percentage = totalBudget > 0 ? (totalExpenses / totalBudget) * 100 : 0; const percentageColor = percentage > 100 ? 'text-red-500' : (percentage > 80 ? 'text-yellow-500' : 'text-green-500'); budgetText.innerHTML = `<span class="text-3xl font-bold ${percentageColor}">${percentage.toFixed(0)}%</span><span class="text-sm text-gray-500">Gasto</span>`; } } }
    </script>
</body>
</html>